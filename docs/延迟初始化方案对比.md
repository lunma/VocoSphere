# ğŸ”„ Rust å»¶è¿Ÿåˆå§‹åŒ–æ–¹æ¡ˆå®Œå…¨å¯¹æ¯”

## ğŸ“Š å››ç§æ–¹æ¡ˆå¯¹æ¯”è¡¨

| æ–¹æ¡ˆ | Rust ç‰ˆæœ¬ | ä¾èµ– | åˆå§‹åŒ–æ—¶æœº | åˆå§‹åŒ–æ–¹å¼ | é€‚ç”¨åœºæ™¯ |
|------|-----------|------|-----------|-----------|---------|
| **ç›´æ¥ static** | ä»»æ„ | âŒ æ—  | ç¼–è¯‘æ—¶ | const fn | ç®€å•ç±»å‹ âœ¨ |
| **OnceLock** | 1.70+ | âŒ æ—  | è¿è¡Œæ—¶æ‰‹åŠ¨ | `set()` / `get_or_init()` | åŠ¨æ€åˆå§‹åŒ– |
| **LazyLock** | 1.80+ | âŒ æ—  | é¦–æ¬¡è®¿é—®è‡ªåŠ¨ | æ„é€ æ—¶æä¾›é—­åŒ… | å›ºå®šé€»è¾‘ |
| **lazy_static** | ä»»æ„ | âœ… éœ€è¦ | é¦–æ¬¡è®¿é—®è‡ªåŠ¨ | å® + é—­åŒ… | è€é¡¹ç›® |

## ğŸ’¡ ä»£ç ç¤ºä¾‹å¯¹æ¯”

### 1. ç›´æ¥ staticï¼ˆæœ€ç®€å•ï¼‰âœ¨

```rust
use std::sync::atomic::AtomicBool;

// âœ… ç¼–è¯‘æ—¶åˆå§‹åŒ–ï¼Œé›¶å¼€é”€
static IS_RECORDING: AtomicBool = AtomicBool::new(false);

fn main() {
    IS_RECORDING.store(true, Ordering::SeqCst);
    println!("{}", IS_RECORDING.load(Ordering::SeqCst));
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æœ€ç®€å•
- âœ… é›¶è¿è¡Œæ—¶å¼€é”€
- âœ… æ— éœ€ä¾èµ–

**é™åˆ¶**ï¼š
- âš ï¸ åªèƒ½ç”¨ `const fn` åˆå§‹åŒ–
- âš ï¸ ä¸èƒ½åŒ…å«è¿è¡Œæ—¶è®¡ç®—

**é€‚ç”¨ç±»å‹**ï¼š
- `AtomicBool`, `AtomicU32`, `AtomicI64` ç­‰
- åŸºæœ¬ç±»å‹ï¼š`bool`, `i32`, `&str` ç­‰

### 2. OnceLockï¼ˆæ‰‹åŠ¨åˆå§‹åŒ–ï¼‰

```rust
use std::sync::OnceLock;

static CONFIG: OnceLock<String> = OnceLock::new();

fn main() {
    // æ–¹å¼ 1ï¼šæ˜¾å¼è®¾ç½®
    CONFIG.set("hello".to_string()).ok();
    
    // æ–¹å¼ 2ï¼šè·å–æˆ–åˆå§‹åŒ–
    let value = CONFIG.get_or_init(|| {
        // åªåœ¨æœªè®¾ç½®æ—¶æ‰§è¡Œ
        expensive_computation()
    });
    
    // æ–¹å¼ 3ï¼šå°è¯•è·å–
    if let Some(v) = CONFIG.get() {
        println!("{}", v);
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… çµæ´»ï¼šå¤–éƒ¨æ§åˆ¶ä½•æ—¶åˆå§‹åŒ–
- âœ… å¯ä»¥å¤±è´¥ï¼š`set()` è¿”å› Result
- âœ… å¯é€‰åˆå§‹åŒ–ï¼šä¸ä¸€å®šè¦åˆå§‹åŒ–

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦å¤–éƒ¨å‚æ•°åˆå§‹åŒ–
- åˆå§‹åŒ–æ—¶æœºä¸ç¡®å®š
- å¯èƒ½åˆå§‹åŒ–å¤±è´¥

### 3. LazyLockï¼ˆè‡ªåŠ¨åˆå§‹åŒ–ï¼‰

```rust
use std::sync::LazyLock;

// é¦–æ¬¡è®¿é—®æ—¶è‡ªåŠ¨æ‰§è¡Œé—­åŒ…
static CONFIG: LazyLock<String> = LazyLock::new(|| {
    // è¿™é‡Œå¯ä»¥åšå¤æ‚è®¡ç®—
    std::fs::read_to_string("config.txt").unwrap()
});

fn main() {
    // é¦–æ¬¡è®¿é—®ï¼Œè§¦å‘åˆå§‹åŒ–
    println!("{}", &*CONFIG);
    
    // åç»­è®¿é—®ï¼Œç›´æ¥è¿”å›
    println!("{}", &*CONFIG);
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… è‡ªåŠ¨åˆå§‹åŒ–ï¼šæ— éœ€æ‰‹åŠ¨è°ƒç”¨
- âœ… ç±»ä¼¼ lazy_static
- âœ… æ— éœ€å¤–éƒ¨ crate

**é€‚ç”¨åœºæ™¯**ï¼š
- å›ºå®šçš„åˆå§‹åŒ–é€»è¾‘
- é¦–æ¬¡è®¿é—®æ—¶åˆå§‹åŒ–
- æ›¿ä»£ lazy_static

### 4. lazy_staticï¼ˆè€æ–¹å¼ï¼‰

```rust
use lazy_static::lazy_static;

lazy_static! {
    static ref CONFIG: String = {
        std::fs::read_to_string("config.txt").unwrap()
    };
}

fn main() {
    println!("{}", &*CONFIG);
}
```

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦å¤–éƒ¨ crate
- âŒ å®è¯­æ³•
- âŒ Rust 1.80+ ä¸æ¨è

## ğŸ¯ åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„é€‰æ‹©

### å½“å‰ä»£ç ï¼ˆæœ€ä¼˜ï¼‰

```rust
// âœ… AtomicBool æ”¯æŒ const åˆå§‹åŒ–ï¼Œç›´æ¥ç”¨ static
static IS_RECORDING: AtomicBool = AtomicBool::new(false);
```

### å¦‚æœè¦ç”¨ OnceLockï¼ˆæ— å¿…è¦ï¼‰

```rust
use std::sync::OnceLock;

static IS_RECORDING: OnceLock<AtomicBool> = OnceLock::new();

pub async fn start_audio_capture() -> Result<String, String> {
    let flag = IS_RECORDING.get_or_init(|| AtomicBool::new(false));
    //                      ^^^^^^^^^^^  ^^^^^^^^^^^^^^^^^^^^^^
    //                      è·å–æˆ–åˆå§‹åŒ–  åˆå§‹åŒ–é—­åŒ…
    
    match flag.compare_exchange(false, true, ...) {
        // ...
    }
}
```

**é—®é¢˜**ï¼š
- âš ï¸ å¤šä¸€å±‚åŒ…è£…
- âš ï¸ æ¯æ¬¡éƒ½è¦ `get_or_init()`
- âš ï¸ è¯­æ³•æ›´å¤æ‚
- âŒ æ²¡æœ‰ä»»ä½•å¥½å¤„

### å¦‚æœè¦ç”¨ LazyLockï¼ˆæ— å¿…è¦ï¼‰

```rust
use std::sync::LazyLock;

static IS_RECORDING: LazyLock<AtomicBool> = LazyLock::new(|| {
    AtomicBool::new(false)
});

pub async fn start_audio_capture() -> Result<String, String> {
    match (*IS_RECORDING).compare_exchange(false, true, ...) {
        //    ^^^^^^^^^^^^^^ éœ€è¦è§£å¼•ç”¨
        // ...
    }
}
```

**é—®é¢˜**ï¼š
- âš ï¸ éœ€è¦è§£å¼•ç”¨ `*`
- âš ï¸ éœ€è¦ Rust 1.80+
- âŒ æ²¡æœ‰ä»»ä½•å¥½å¤„

## ğŸ“‹ å†³ç­–æ ‘

```
ä½ çš„ç±»å‹æ˜¯ï¼Ÿ
â”‚
â”œâ”€ AtomicBool / AtomicU32 ç­‰åŸå­ç±»å‹
â”‚  â””â”€> âœ… ç›´æ¥ static
â”‚      static FLAG: AtomicBool = AtomicBool::new(false);
â”‚
â”œâ”€ String / Vec / HashMap ç­‰ï¼ˆéœ€è¦å †åˆ†é…ï¼‰
â”‚  â”‚
â”‚  â”œâ”€ åˆå§‹åŒ–é€»è¾‘å›ºå®šï¼Ÿ
â”‚  â”‚  â”œâ”€ æ˜¯ â†’ âœ… LazyLock
â”‚  â”‚  â”‚   static DATA: LazyLock<Vec<i32>> = LazyLock::new(|| vec![1,2,3]);
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ å¦ â†’ âœ… OnceLock
â”‚  â”‚      static DATA: OnceLock<Vec<i32>> = OnceLock::new();
â”‚  â”‚      DATA.set(vec![1,2,3]);
â”‚  â”‚
â”‚  â””â”€ Rust < 1.70ï¼Ÿ
â”‚     â””â”€> âœ… lazy_static
â”‚
â””â”€ è‡ªå®šä¹‰ç»“æ„ä½“
   â””â”€> å¦‚ä¸Š String/Vec çš„é€»è¾‘
```

## ğŸ¯ æ€»ç»“

### æˆ‘ä»¬çš„é¡¹ç›®

```rust
// âœ… æœ€ä½³é€‰æ‹©
static IS_RECORDING: AtomicBool = AtomicBool::new(false);
```

**åŸå› **ï¼š
1. `AtomicBool::new()` æ˜¯ const fn
2. æ— éœ€å»¶è¿Ÿåˆå§‹åŒ–
3. æœ€ç®€å•ã€æœ€å¿«

### ä»€ä¹ˆæ—¶å€™ç”¨ OnceLockï¼Ÿ

```rust
// éœ€è¦ä»å¤–éƒ¨è®¾ç½®å€¼
static API_KEY: OnceLock<String> = OnceLock::new();

fn init(key: String) {
    API_KEY.set(key).unwrap();
}
```

### ä»€ä¹ˆæ—¶å€™ç”¨ LazyLockï¼Ÿ

```rust
// å›ºå®šçš„åˆå§‹åŒ–é€»è¾‘
static CONFIG: LazyLock<Config> = LazyLock::new(|| {
    Config::load()
});
```

### ä»€ä¹ˆæ—¶å€™ç”¨ lazy_staticï¼Ÿ

```rust
// Rust < 1.80 çš„è€é¡¹ç›®
// æˆ–è€…ä¸æƒ³å‡çº§ Rust ç‰ˆæœ¬
lazy_static! {
    static ref CONFIG: Config = Config::load();
}
```

---

**æ ¸å¿ƒåŸåˆ™**ï¼š
- èƒ½ç”¨ `static` å°±ç”¨ `static`ï¼ˆæœ€ç®€å•ï¼‰
- éœ€è¦å»¶è¿Ÿåˆå§‹åŒ–æ‰ç”¨ `OnceLock` / `LazyLock`
- ä¸è¦è¿‡åº¦è®¾è®¡

