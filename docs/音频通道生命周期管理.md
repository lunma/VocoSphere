# éŸ³é¢‘é€šé“ç”Ÿå‘½å‘¨æœŸç®¡ç†

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†éŸ³é¢‘é‡‡é›†æ¨¡å—ä¸­ `mpsc` é€šé“ï¼ˆSender/Receiverï¼‰çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†æœºåˆ¶ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡æ‰€æœ‰æƒç³»ç»Ÿå®ç°ä¼˜é›…çš„èµ„æºæ¸…ç†ã€‚

## é€šé“åˆ›å»º

### åˆ›å»ºä½ç½®
åœ¨ `audio_capture.rs` çš„ `run_audio_capture()` å‡½æ•°ä¸­ï¼š

```rust
// ç¬¬ 174 è¡Œ
let (tx, rx) = mpsc::channel::<Vec<f32>>(1000);
```

### é€šé“ä½œç”¨
- **Sender (tx)**: åœ¨éŸ³é¢‘å›è°ƒä¸­å‘é€å¤„ç†åçš„éŸ³é¢‘æ•°æ®
- **Receiver (rx)**: åœ¨ WebSocket ä»»åŠ¡ä¸­æ¥æ”¶éŸ³é¢‘æ•°æ®å¹¶å‘é€åˆ°æœåŠ¡å™¨
- **ç¼“å†²å®¹é‡**: 1000 ä¸ªå¸§ï¼Œé˜²æ­¢éŸ³é¢‘é‡‡é›†å’Œç½‘ç»œå‘é€é€Ÿåº¦ä¸åŒ¹é…

## Sender çš„ç”Ÿå‘½å‘¨æœŸ

### 1. åˆ›å»ºé˜¶æ®µ (ç¬¬ 174 è¡Œ)
```rust
let (tx, rx) = mpsc::channel::<Vec<f32>>(1000);
```

### 2. ç§»åŠ¨åˆ° RecordingState (ç¬¬ 204-218 è¡Œ)
```rust
let mut recording_state = audio::RecordingState {
    resampler,
    sample_buffer: Vec::with_capacity(...),
    channel_data: vec![...],
    tx,  // â† Sender ç§»åŠ¨åˆ°è¿™é‡Œ
    volume_stats: audio::VolumeStats { ... },
};
```

### 3. ç§»åŠ¨åˆ°éŸ³é¢‘æµé—­åŒ… (ç¬¬ 224-234 è¡Œ)
```rust
let stream = device.build_input_stream(
    &stream_config,
    move |data: &[f32], _: &InputCallbackInfo| {
        // recording_state (åŒ…å« tx) è¢« move åˆ°æ­¤é—­åŒ…
        audio::process_audio_data(data, &mut recording_state, &audio_config);
    },
    err_fn,
    None,
)?;
```

**å…³é”®ç‚¹**ï¼š
- `move` å…³é”®å­—å°† `recording_state` çš„æ‰€æœ‰æƒè½¬ç§»ç»™é—­åŒ…
- é—­åŒ…çš„ç”Ÿå‘½å‘¨æœŸä¸ `stream` ç»‘å®š
- `tx` ç°åœ¨è¢«é—­åŒ…æŒæœ‰ï¼Œåœ¨éŸ³é¢‘å›è°ƒä¸­ä½¿ç”¨

### 4. é”€æ¯é˜¶æ®µ (ç¬¬ 273 è¡Œ)

#### è§¦å‘æ¡ä»¶
ç”¨æˆ·è°ƒç”¨ `stop_audio_capture()`ï¼š

```rust
// ç¬¬ 68 è¡Œï¼šè®¾ç½®åœæ­¢æ ‡å¿—
let was_recording = IS_RECORDING.swap(false, Ordering::SeqCst);
```

#### é”€æ¯è¿‡ç¨‹
```rust
// ç¬¬ 266-268 è¡Œï¼šç­‰å¾…å¾ªç¯é€€å‡º
while IS_RECORDING.load(Ordering::Relaxed) {
    thread::sleep(Duration::from_millis(100));
}

info!("â¹ï¸  æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œæ­£åœ¨æ¸…ç†èµ„æº...");

// ç¬¬ 273 è¡Œï¼šé”€æ¯éŸ³é¢‘æµ
drop(stream);  // â† Sender åœ¨è¿™é‡Œè¢«é”€æ¯
```

**é”€æ¯é“¾**ï¼š
```
drop(stream)
  â””â”€> é”€æ¯éŸ³é¢‘æµå›è°ƒé—­åŒ…
       â””â”€> é”€æ¯ recording_state
            â””â”€> é”€æ¯ tx (Sender)
```

## Receiver çš„é€€å‡ºæœºåˆ¶

### æ¥æ”¶å¾ªç¯ (common.rs ç¬¬ 103 è¡Œ)

```rust
while let Some(samples) = receiver.recv().await {
    // å¤„ç†éŸ³é¢‘æ•°æ®...
}
```

### é€€å‡ºæ¡ä»¶

#### 1. æ‰€æœ‰ Sender è¢«é”€æ¯ â­ **æœ€å¸¸è§**
- å½“ `tx` è¢« drop åï¼Œ`rx.recv().await` è¿”å› `None`
- å¾ªç¯è‡ªåŠ¨é€€å‡º
- **è¿™æ˜¯æ­£å¸¸çš„é€šé“å…³é—­æœºåˆ¶**

#### 2. å‘é€ç«¯ä»»åŠ¡å´©æºƒ
- å¦‚æœæŒæœ‰ Sender çš„ä»»åŠ¡å¼‚å¸¸ç»ˆæ­¢
- Sender ä¼šè¢«è‡ªåŠ¨é”€æ¯
- Receiver åŒæ ·æ”¶åˆ° `None`

#### 3. é€šé“è¢«æ˜¾å¼å…³é—­
- è™½ç„¶ä»£ç ä¸­æœªä½¿ç”¨ï¼Œä½† mpsc é€šé“æ”¯æŒæ˜¾å¼å…³é—­

### é€€å‡ºåè¡Œä¸º (common.rs ç¬¬ 141-142 è¡Œ)

```rust
info!("éŸ³é¢‘æµå‘é€å®Œæˆ");
ws_write  // è¿”å› ws_write ä¾›è°ƒç”¨è€…å‘é€ç»“æŸå¸§
```

## å®Œæ•´çš„è°ƒç”¨é“¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·ç‚¹å‡»åœæ­¢æŒ‰é’®                      â”‚
â”‚    invoke('stop_audio_capture')         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è®¾ç½®åœæ­¢æ ‡å¿—                          â”‚
â”‚    IS_RECORDING.swap(false)  (ç¬¬ 68 è¡Œ)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. while å¾ªç¯æ£€æµ‹åˆ°æ ‡å¿—å˜åŒ–              â”‚
â”‚    while IS_RECORDING.load() { ... }     â”‚
â”‚    (ç¬¬ 266-268 è¡Œ)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. é”€æ¯éŸ³é¢‘æµ                            â”‚
â”‚    drop(stream)  (ç¬¬ 273 è¡Œ)             â”‚
â”‚    â”œâ”€> é”€æ¯é—­åŒ…                          â”‚
â”‚    â”œâ”€> é”€æ¯ recording_state              â”‚
â”‚    â””â”€> é”€æ¯ tx (Sender)  â† å…³é”®æ­¥éª¤      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Receiver æ”¶åˆ°é€šé“å…³é—­ä¿¡å·             â”‚
â”‚    rx.recv().await è¿”å› None             â”‚
â”‚    (common.rs ç¬¬ 103 è¡Œ)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. WebSocket å‘é€å¾ªç¯é€€å‡º                â”‚
â”‚    while let Some(...) å¾ªç¯ç»“æŸ          â”‚
â”‚    æ‰“å° "éŸ³é¢‘æµå‘é€å®Œæˆ"                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è®¾è®¡ä¼˜åŠ¿

### 1. **è‡ªåŠ¨èµ„æºç®¡ç†**
- æ— éœ€æ‰‹åŠ¨å‘é€åœæ­¢ä¿¡å·
- åˆ©ç”¨ Rust æ‰€æœ‰æƒç³»ç»Ÿè‡ªåŠ¨æ¸…ç†
- é¿å…èµ„æºæ³„æ¼

### 2. **çº¿ç¨‹å®‰å…¨**
- ä½¿ç”¨åŸå­æ“ä½œ (`AtomicBool`) æ§åˆ¶çŠ¶æ€
- `mpsc` é€šé“æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„
- æ— éœ€é¢å¤–çš„é”æœºåˆ¶

### 3. **ä¼˜é›…çš„çº§è”æ¸…ç†**
```
stream -> é—­åŒ… -> recording_state -> tx -> rx æ”¶åˆ° None -> å¾ªç¯é€€å‡º
```

### 4. **ä½å»¶è¿Ÿè®¾è®¡**
- 100ms è½®è¯¢é—´éš”ï¼ˆç¬¬ 267 è¡Œï¼‰
- éŸ³é¢‘æµç«‹å³åœæ­¢ï¼ˆdrop æ˜¯åŒæ­¥æ“ä½œï¼‰
- WebSocket å¾ªç¯è‡ªç„¶é€€å‡º

## æ³¨æ„äº‹é¡¹

### ä¸ºä»€ä¹ˆä½¿ç”¨ `thread::sleep` è€Œä¸æ˜¯ `tokio::time::sleep`ï¼Ÿ

```rust
// ç¬¬ 262-268 è¡Œ
while IS_RECORDING.load(Ordering::Relaxed) {
    thread::sleep(Duration::from_millis(100));  // ä½¿ç”¨ std::thread::sleep
}
```

**åŸå› **ï¼š
1. `cpal::Stream` ä¸æ˜¯ `Send`ï¼Œæ— æ³•è·¨ `await` ç‚¹
2. å¿…é¡»åœ¨åˆ›å»º `stream` çš„åŒä¸€çº¿ç¨‹ä¸­æŒæœ‰å®ƒ
3. ä½¿ç”¨ `thread::sleep` é¿å… async ä¸Šä¸‹æ–‡åˆ‡æ¢
4. 100ms è½®è¯¢å¯¹æ€§èƒ½å½±å“å¯å¿½ç•¥

### é€šé“å®¹é‡ä¸ºä»€ä¹ˆæ˜¯ 1000ï¼Ÿ

```rust
let (tx, rx) = mpsc::channel::<Vec<f32>>(1000);
```

**è®¡ç®—**ï¼š
- æ¯å¸§çº¦ 50msï¼ˆframe_size=800, 16kHz é‡‡æ ·ç‡ï¼‰
- 1000 å¸§ = 50 ç§’ç¼“å†²
- è¶³ä»¥åº”å¯¹ç½‘ç»œæ³¢åŠ¨å’Œä¸´æ—¶é˜»å¡
- é¿å…éŸ³é¢‘ä¸¢å¤±

### Debug æ¨¡å¼çš„é¢å¤–æ¸…ç†

```rust
// ç¬¬ 276-282 è¡Œ
#[cfg(debug_assertions)]
{
    info!("ğŸ’¾ ä¿å­˜è°ƒè¯•éŸ³é¢‘æ–‡ä»¶...");
    utils::file::save_wav_writer(original_writer)?;
    utils::file::save_wav_writer(verification_writer)?;
    info!("âœ… è°ƒè¯•æ–‡ä»¶å·²ä¿å­˜åˆ° {}", output_dir);
}
```

åœ¨ Debug æ¨¡å¼ä¸‹ï¼Œåœæ­¢åè¿˜ä¼šä¿å­˜ WAV æ–‡ä»¶ç”¨äºè°ƒè¯•ã€‚

## ç›¸å…³æ–‡ä»¶

- `src-tauri/src/audio_capture.rs` - éŸ³é¢‘é‡‡é›†ä¸»é€»è¾‘
- `src-tauri/src/asr/websocket/common.rs` - WebSocket éŸ³é¢‘å‘é€
- `src-tauri/src/audio/mod.rs` - RecordingState å®šä¹‰

## æ€»ç»“

è¿™ä¸ªè®¾è®¡å……åˆ†åˆ©ç”¨äº† Rust çš„æ‰€æœ‰æƒç³»ç»Ÿï¼Œé€šè¿‡ RAIIï¼ˆResource Acquisition Is Initializationï¼‰æ¨¡å¼å®ç°äº†ï¼š
- âœ… è‡ªåŠ¨åŒ–èµ„æºç®¡ç†
- âœ… é›¶é¢å¤–å¼€é”€çš„çº¿ç¨‹å®‰å…¨
- âœ… ä¼˜é›…çš„çº§è”æ¸…ç†
- âœ… æ— éœ€æ‰‹åŠ¨ä¿¡å·ä¼ é€’
- âœ… ç¼–è¯‘æ—¶ä¿è¯çš„å†…å­˜å®‰å…¨

æ˜¯ä¸€ä¸ªæ•™ç§‘ä¹¦çº§åˆ«çš„ Rust å¼‚æ­¥èµ„æºç®¡ç†å®è·µæ¡ˆä¾‹ã€‚

