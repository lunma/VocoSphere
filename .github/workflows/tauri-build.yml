name: Tauri Build # GitHub Actions 工作流名称：Tauri 应用编译

on:
  # 触发条件：推送 / PR 到 main 分支，或手动触发
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.platform }} # 按操作系统矩阵分别构建
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - macos-latest
          - ubuntu-latest
          - windows-latest

    env:
      RUSTFLAGS: "-C target-cpu=native" # 优化 Rust 编译产物使用当前 CPU 指令集

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.7

      - name: Setup pnpm
        uses: pnpm/action-setup@v2.4.0
        with:
          version: 10.15.1
          run_install: false
          standalone: true

      - name: Setup Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: "22.14.0"
          cache: "pnpm"

      - name: Install system dependencies (Linux only)
        if: matrix.platform == 'ubuntu-latest'
        # Ubuntu 构建环境所需的系统库
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@1.84.0
        # 安装稳定版 Rust（含 cargo、rustup）

      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@v2.7.3
        with:
          workspaces: |
            src-tauri -> target
        # 缓存 Rust 编译产物，加速后续构建

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile
        # 安装前端依赖，保持 lockfile 一致

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0.5.13
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        with:
          projectPath: .
          tauriScript: pnpm tauri
          distPath: dist # 前端静态资源目录（Vite 构建输出）

      - name: Upload bundles
        if: always()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: tauri-bundle-${{ matrix.platform }}
          path: src-tauri/target/release/bundle/**
          if-no-files-found: warn
        # 将各平台的打包产物上传为构建工件，便于下载测试

