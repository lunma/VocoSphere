name: VocoSphere Build # GitHub Actions å·¥ä½œæµåç§°ï¼šTauri åº”ç”¨ç¼–è¯‘

on:
  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ / PR åˆ° main åˆ†æ”¯ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘ï¼Œæˆ–æ¨é€ tag æ—¶åˆ›å»º Release
  push:
    branches: [main]
    tags:
      - 'v*' # åŒ¹é… v å¼€å¤´çš„ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.platform }} # æŒ‰æ“ä½œç³»ç»ŸçŸ©é˜µåˆ†åˆ«æ„å»º
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - macos-latest
          - ubuntu-latest
          - windows-latest

    env:
      # æ˜¾å¼è®¾ç½®å¯ä»¥ç¡®ä¿åœ¨æ‰€æœ‰åœºæ™¯ä¸‹éƒ½ä½¿ç”¨ç”Ÿäº§æ¨¡å¼ï¼ˆä»£ç å‹ç¼©ã€tree-shaking ç­‰ï¼‰
      NODE_ENV: "production"
      # Rust ç¼–è¯‘ä¼˜åŒ–æ ‡å¿—ï¼šé’ˆå¯¹å½“å‰ CPU æŒ‡ä»¤é›†ä¼˜åŒ–
      RUSTFLAGS: "-C target-cpu=native"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.23.0
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.21.1
          cache: "pnpm"

      - name: Install system dependencies (Linux only)
        if: matrix.platform == 'ubuntu-latest'
        # Ubuntu æ„å»ºç¯å¢ƒæ‰€éœ€çš„ç³»ç»Ÿåº“
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf  \
            libasound2-dev

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@1.91.1
        # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Rustï¼ˆå« cargoã€rustupï¼‰

      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@v2.8.0
        with:
          workspaces: |
            src-tauri -> target
        # ç¼“å­˜ Rust ç¼–è¯‘äº§ç‰©ï¼ŒåŠ é€Ÿåç»­æ„å»º

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile
        # å®‰è£…å‰ç«¯ä¾èµ–ï¼Œä¿æŒ lockfile ä¸€è‡´

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0.5.13
        # env:
        #   TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        #   TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        #   APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        #   APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        #   APPLE_ID: ${{ secrets.APPLE_ID }}
        #   APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        #   APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        #   APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        with:
          projectPath: .
          tauriScript: pnpm tauri
          distPath: dist # å‰ç«¯é™æ€èµ„æºç›®å½•ï¼ˆVite æ„å»ºè¾“å‡ºï¼‰

      - name: Upload bundles
        if: always()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: vocosphere-bundle-${{ matrix.platform }}
          path: src-tauri/target/release/bundle/**
          if-no-files-found: warn
        # å°†å„å¹³å°çš„æ‰“åŒ…äº§ç‰©ä¸Šä¼ ä¸ºæ„å»ºå·¥ä»¶ï¼Œä¾¿äºä¸‹è½½æµ‹è¯•

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    # ä»…åœ¨æ¨é€ tag æ—¶åˆ›å»º Release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º Release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: vocosphere-bundle-*
          merge-multiple: false

      - name: Determine release type
        id: release-type
        run: |
          TAG_NAME="${{ github.ref_name }}"
          if [[ "$TAG_NAME" == *"-draft"* ]]; then
            echo "is_draft=true" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "release_type=è‰ç¨¿" >> $GITHUB_OUTPUT
          elif [[ "$TAG_NAME" == *"-alpha"* ]] || [[ "$TAG_NAME" == *"-beta"* ]] || [[ "$TAG_NAME" == *"-rc"* ]]; then
            echo "is_draft=false" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "release_type=é¢„å‘å¸ƒ" >> $GITHUB_OUTPUT
          else
            echo "is_draft=false" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "release_type=æ­£å¼å‘å¸ƒ" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## ğŸ‰ Release ${{ github.ref_name }} (${{ steps.release-type.outputs.release_type }})

            ### ğŸ“¦ æ„å»ºäº§ç‰©

            æœ¬æ¬¡å‘å¸ƒåŒ…å«ä»¥ä¸‹å¹³å°çš„æ„å»ºäº§ç‰©ï¼š
            - **macOS** (.dmg / .app)
            - **Linux** (.deb / .AppImage)
            - **Windows** (.msi / .exe)

            ### ğŸ“ å˜æ›´è¯´æ˜
            - æŸ¥çœ‹ [æäº¤å†å²](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }})
          files: |
            artifacts/vocosphere-bundle-*/**
          draft: ${{ steps.release-type.outputs.is_draft }}
          prerelease: ${{ steps.release-type.outputs.is_prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

