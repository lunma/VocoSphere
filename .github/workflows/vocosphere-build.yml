name: VocoSphere Build # GitHub Actions å·¥ä½œæµåç§°ï¼šTauri åº”ç”¨ç¼–è¯‘

on:
  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ / PR åˆ° main åˆ†æ”¯ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘ï¼Œæˆ–æ¨é€ tag æ—¶åˆ›å»º Release
  push:
    branches: [main]
    tags:
      - 'v*' # åŒ¹é… v å¼€å¤´çš„ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  # å¯¹äº tag æ¨é€ï¼šä½¿ç”¨ç»Ÿä¸€çš„ç»„ï¼Œæ–° tag ä¼šå–æ¶ˆæ—§çš„æ„å»º
  # å¯¹äºåˆ†æ”¯æ¨é€ï¼šä½¿ç”¨ç‹¬ç«‹çš„ç»„ï¼Œå¯ä»¥å¹¶è¡Œ
  group: ${{ github.workflow }}-${{ startsWith(github.ref, 'refs/tags/') && 'tags' || github.ref }}
  cancel-in-progress: ${{ startsWith(github.ref, 'refs/tags/') }}  # tag æ¨é€æ—¶å–æ¶ˆæ—§çš„æ„å»º
jobs:
  build:
    name: Build on ${{ matrix.platform }} # æŒ‰æ“ä½œç³»ç»ŸçŸ©é˜µåˆ†åˆ«æ„å»º
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - macos-latest
          - ubuntu-latest
          - windows-latest

    env:
      # æ˜¾å¼è®¾ç½®å¯ä»¥ç¡®ä¿åœ¨æ‰€æœ‰åœºæ™¯ä¸‹éƒ½ä½¿ç”¨ç”Ÿäº§æ¨¡å¼ï¼ˆä»£ç å‹ç¼©ã€tree-shaking ç­‰ï¼‰
      NODE_ENV: "production"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.23.0
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.21.1
          cache: "pnpm"

      - name: Install system dependencies (Linux only)
        if: matrix.platform == 'ubuntu-latest'
        # Ubuntu æ„å»ºç¯å¢ƒæ‰€éœ€çš„ç³»ç»Ÿåº“
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf  \
            libasound2-dev

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@1.91.1
        # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Rustï¼ˆå« cargoã€rustupï¼‰

      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@v2.8.0
        with:
          workspaces: |
            src-tauri -> target
          cache-on-failure: true  # å³ä½¿æ„å»ºå¤±è´¥ä¹Ÿä¿å­˜ç¼“å­˜ï¼Œä¾¿äºè°ƒè¯•
        # ç¼“å­˜ Rust ç¼–è¯‘äº§ç‰©ï¼ŒåŠ é€Ÿåç»­æ„å»ºï¼ˆä¸åŒå¹³å°è‡ªåŠ¨ä½¿ç”¨ä¸åŒçš„ç¼“å­˜ keyï¼‰

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile
        # å®‰è£…å‰ç«¯ä¾èµ–ï¼Œä¿æŒ lockfile ä¸€è‡´

      - name: Fix code formatting and line endings
        run: |
          # è¿è¡Œ Prettier è‡ªåŠ¨ä¿®å¤æ ¼å¼å’Œè¡Œå°¾ç¬¦
          pnpm format
          # è¿è¡Œ ESLint è‡ªåŠ¨ä¿®å¤å¯ä¿®å¤çš„é—®é¢˜
          pnpm lint:fix
        # è¿™ä¼šä¿®å¤è¡Œå°¾ç¬¦å’Œå…¶ä»–æ ¼å¼é—®é¢˜ï¼Œç¡®ä¿ä»£ç ç¬¦åˆè§„èŒƒ

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0.5.13
        # env:
        #   TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        #   TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        #   APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        #   APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        #   APPLE_ID: ${{ secrets.APPLE_ID }}
        #   APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        #   APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        #   APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        with:
          projectPath: .
          tauriScript: pnpm tauri
          distPath: dist # å‰ç«¯é™æ€èµ„æºç›®å½•ï¼ˆVite æ„å»ºè¾“å‡ºï¼‰

      - name: Upload bundles
        if: always()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: vocosphere-bundle-${{ matrix.platform }}
          path: src-tauri/target/release/bundle/**
          if-no-files-found: warn
        # å°†å„å¹³å°çš„æ‰“åŒ…äº§ç‰©ä¸Šä¼ ä¸ºæ„å»ºå·¥ä»¶ï¼Œä¾¿äºä¸‹è½½æµ‹è¯•

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    # ä»…åœ¨æ¨é€ tag æ—¶åˆ›å»º Release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º Release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ï¼ŒåŒ…æ‹¬æ‰€æœ‰ tags

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: vocosphere-bundle-*
          merge-multiple: false

      - name: List downloaded artifacts
        run: |
          echo "ğŸ“¦ ä¸‹è½½çš„æ„å»ºäº§ç‰©ç»“æ„ï¼š"
          find ./artifacts -type f 2>/dev/null | head -20 || echo "æœªæ‰¾åˆ°æ–‡ä»¶"
          echo ""
          echo "ğŸ“ ç›®å½•ç»“æ„ï¼š"
          ls -laR ./artifacts 2>/dev/null | head -30 || echo "ç›®å½•ä¸ºç©º"

      - name: Check artifacts exist
        id: check-artifacts
        run: |
          ARTIFACT_COUNT=$(find ./artifacts -type f 2>/dev/null | wc -l || echo "0")
          echo "æ‰¾åˆ° $ARTIFACT_COUNT ä¸ªæ–‡ä»¶"
          if [ "$ARTIFACT_COUNT" -eq "0" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•æ„å»ºäº§ç‰©ï¼"
            echo "è¯·æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸï¼Œæˆ– artifacts ä¸Šä¼ æ˜¯å¦æ­£ç¡®ã€‚"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©ï¼Œç»§ç»­åˆ›å»º Release"

      - name: Get previous tag
        id: previous-tag
        run: |
          CURRENT_TAG="${{ github.ref_name }}"
          # è·å–æ‰€æœ‰ tagï¼ŒæŒ‰ç‰ˆæœ¬å·æ’åºï¼Œæ‰¾åˆ°å½“å‰ tag çš„ä¸Šä¸€ä¸ª
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -A 1 "^${CURRENT_TAG}$" | tail -1 || echo "")
          if [ -z "$PREVIOUS_TAG" ] || [ "$PREVIOUS_TAG" = "$CURRENT_TAG" ]; then
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€ä¸ª tagï¼Œä½¿ç”¨ main åˆ†æ”¯
            echo "compare_url=https://github.com/${{ github.repository }}/compare/main...${CURRENT_TAG}" >> $GITHUB_OUTPUT
            echo "compare_text=main...${CURRENT_TAG}" >> $GITHUB_OUTPUT
          else
            echo "compare_url=https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${CURRENT_TAG}" >> $GITHUB_OUTPUT
            echo "compare_text=${PREVIOUS_TAG}...${CURRENT_TAG}" >> $GITHUB_OUTPUT
          fi

      - name: Determine release type
        id: release-type
        run: |
          TAG_NAME="${{ github.ref_name }}"
          if [[ "$TAG_NAME" == *"-draft"* ]]; then
            echo "is_draft=true" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "release_type=è‰ç¨¿" >> $GITHUB_OUTPUT
          elif [[ "$TAG_NAME" == *"-alpha"* ]] || [[ "$TAG_NAME" == *"-beta"* ]] || [[ "$TAG_NAME" == *"-rc"* ]]; then
            echo "is_draft=false" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "release_type=é¢„å‘å¸ƒ" >> $GITHUB_OUTPUT
          else
            echo "is_draft=false" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "release_type=æ­£å¼å‘å¸ƒ" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## ğŸ‰ Release ${{ github.ref_name }} (${{ steps.release-type.outputs.release_type }})

            ### ğŸ“¦ æ„å»ºäº§ç‰©

            æœ¬æ¬¡å‘å¸ƒåŒ…å«ä»¥ä¸‹å¹³å°çš„æ„å»ºäº§ç‰©ï¼š
            - **macOS** (.dmg / .app)
            - **Linux** (.deb / .AppImage)
            - **Windows** (.msi / .exe)

            ### ğŸ“ å˜æ›´è¯´æ˜
            - æŸ¥çœ‹ [æäº¤å†å²](${{ steps.previous-tag.outputs.compare_url }}) (${{ steps.previous-tag.outputs.compare_text }})
          files: |
            artifacts/vocosphere-bundle-*/dmg/*.dmg
            artifacts/vocosphere-bundle-*/macos/*.app.tar.gz
            artifacts/vocosphere-bundle-*/nsis/*.exe
            artifacts/vocosphere-bundle-*/msi/*.msi
            artifacts/vocosphere-bundle-*/deb/*.deb
            artifacts/vocosphere-bundle-*/appimage/*.AppImage
          draft: ${{ steps.release-type.outputs.is_draft }}
          prerelease: ${{ steps.release-type.outputs.is_prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

